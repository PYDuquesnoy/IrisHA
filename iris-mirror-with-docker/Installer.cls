Class Demo.Installer
{

XData Install [ XMLNamespace = INSTALLER ]
{
<Manifest>
  <Default Name="SourceDir" Value="/opt/demo" />

  <Default Name="NAMESPACE" Value="DEMO"/>
  <Default Name="DBNAME" Value="DEMO"/>
  <Default Name="APPPATH" Dir="${SourceDir}" />
  <Default Name="CSPAPPPATH" Dir="/csp/demo/" />
  <Default Name="CSPAPPDIR" Dir="${CSPDIR}/demo/" />
  <Default Name="SOURCESPATH" Dir="${APPPATH}src" />
  <Default Name="RESOURCE" Value="%DB_${DBNAME}" /> 

  <Namespace Name="${NAMESPACE}" Code="${DBNAME}-CODE" Data="${DBNAME}-DATA" Create="yes" Ensemble="0">
    <Configuration>
      <Database Name="${DBNAME}-CODE" Dir="${APPPATH}code" Create="yes" Resource="${RESOURCE}" MountRequired="1" />
      <Database Name="${DBNAME}-DATA" Dir="${APPPATH}data" Create="yes" Resource="${RESOURCE}" MountRequired="1" />
    </Configuration>
    
    <CSPApplication Url="${CSPAPPPATH}" Directory="${CSPAPPDIR}" Grant="${RESOURCE}" CookiePath="${CSPAPPPATH}" AuthenticationMethods="64" />

    <Import File="${SOURCESPATH}" Recurse="1"/>
  </Namespace>

</Manifest>
}

/// This is a method generator whose code is generated by XGL. 
/// Main setup method
ClassMethod RunManifest(ByRef pVars, pLogLevel As %Integer = 3, pInstaller As %Installer.Installer) As %Status [ CodeMode = objectgenerator, Internal ]
{
    Quit ##class(%Installer.Manifest).%Generate(%compiledclass, %code, "Install")
}

/// Entry point    
ClassMethod Run() As %Status
{
    try { 
        write "START INSTALLER",! 
        set vars("Namespace") = ..#Namespace 
        set sc = ..RunManifest(.vars) 
        if sc {
            write !,"INSTALLER SUCCESS",!
        } else {
            do $SYSTEM.Process.Terminate($JOB,1)
        }
    } catch ex { 
        set sc = ex.AsStatus() 
        write $System.Status.GetErrorText(sc),! 
        do $SYSTEM.Process.Terminate($JOB,1) 
    } 
    quit sc
}
}
